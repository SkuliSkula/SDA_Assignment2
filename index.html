<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Assignment 2</title>
    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <link rel="stylesheet" href="styles/bootstrap-theme.min.css">
    <script type="text/javascript" src="scripts/jquery.js"></script>
    <script type="text/javascript" src="scripts/bootstrap.js"></script>
    <script type="text/javascript" src="scripts/d3.js"></script>
    <script type="text/javascript" src="scripts/d3tip.js"></script>
    <link rel="stylesheet" href="styles/assignment2.css"> </head>

<body>
    <script type="text/javascript">
        var data2003,data2015, joinedData = [];
        var svgScatter = undefined;
        var margin = {top: 40, right: 20, bottom: 30, left: 30},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;
        var padding = 65;
        var xScale,yScale, rScale, tip;

        // Reading data for 2003 
        d3.csv("https://gist.githubusercontent.com/SkuliSkula/cd6604c5f2edc3e2838c149eeba8bc22/raw/ecbf3a0c79e6a92b10bf3659f60f03d9bc3b758d/distr_prost_vt_count_2003.csv", function(error, data){
            if(error) {
                console.log("Error: ", error);
            } else {
                data.map(function(d) {
                    joinedData.push({"Prostitution": +d.prostitution, "Vehicle_theft": +d.vehicle_theft});
                });
                data2003 = data;
                loadSecondDataSet();
                
            } 
        });
    
    function loadSecondDataSet() {
        
        // Reading the data for visualization 2
        d3.csv("https://gist.githubusercontent.com/SkuliSkula/2ca407f49ff55ff4cf994706a586f022/raw/58f1a9452d94c02c7f96b57a2aa0d31bec1b7bf0/distr_prost_vt_count_2015.csv", function(error, data){
            if(error) {
                console.log("Error: ", error);
            } else {
                data.map(function(d) {
                    joinedData.push({"Prostitution": +d.prostitution, "Vehicle_theft": +d.vehicle_theft});
                });
                data2015 = data;
                initVisualization(data2003, joinedData);
            } 
        });
    }  

    function switchData(data) {
        var dataset = []; 
                
        if(data) {
            dataset = data2003; 
        }
        else{
            dataset = data2015; 
        }

        
        svgScatter.selectAll("circle")
            .data(dataset)
            .transition()
            .delay(function(d,i){
            return i / dataset.length * 1000;
            })
            .duration(500)
            .ease("linear")
            .attr("cx", function(d) {
                return xScale(+d.prostitution);
            })
            .attr("cy", function(d) {
                return yScale(+d.vehicle_theft);
            })
            .attr("r", function(d) {
                return rScale((+d.prostitution + +d.vehicle_theft));
            });
           
        // Add Text Labels
        svgScatter.selectAll("text")
            .data(dataset)
            .text(function(d) {
                return d.district;
            })
            .attr("x", function(d) {
                return xScale(+d.prostitution); 
            })
            .attr("y", function(d) {
                return -10 + yScale(+d.vehicle_theft);
            });
            
    }  
        
    function initVisualization(data, joinedData) {

        // Create an array with Count only to get the max for scaling
        var countProstitutionArray = [];
        var countVehicleTheftArray = [];
        
        joinedData.map(function(d) {
            countProstitutionArray.push(parseInt(d.Prostitution));
            countVehicleTheftArray.push(parseInt(d.Vehicle_theft));
        })
        
        // Join the data so we can scale the radius
        var joined = data.map(function(d){
            return (+d.prostitution + +d.vehicle_theft);  
        });

        xScale = d3.scale.linear()
                     .domain([0, d3.max(countProstitutionArray, function(d) { return d; })])
                     .range([padding, width - padding * 2]);
        
        yScale = d3.scale.linear()
                     .domain([0, d3.max(countVehicleTheftArray, function(d) { return d; })])
                     .range([height - padding, padding]);
        
        rScale = d3.scale.linear()
                     .domain([0, d3.max(joined, function(d) { return d; })])
                     .range([2, 10]);
        
        // Create the tooltip
        tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-10, 0])
            .html(function(d) {
                return "<strong>"+ d.district + ": " +"</strong> <span style='color:red'>" + "(" + d.prostitution +","+ d.vehicle_theft + ")" + "</span>";
            });
        
        
        // Create the SVG
        svgScatter = d3.select("#visualization1")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        
        svgScatter.call(tip);
        
        svgScatter.selectAll("#scatter")
            .data(data)
            .enter()
            .append("circle")  
            .attr("class", "circle")
            .attr("cx", function(d) {
                return xScale(+d.prostitution);
            })
            .attr("cy", function(d) {
                return yScale(+d.vehicle_theft);
            })
            .attr("r", function(d) {
                return rScale((+d.prostitution + +d.vehicle_theft));
            })
            .attr("fill", function(d,i) { return color(i);})
            .on('mouseover', tip.show)
            .on('mouseout', tip.hide);
    
        // Add Text Labels
        svgScatter.selectAll("text")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "district")
            .text(function(d) {
                return d.district;
            })
            .attr("x", function(d) {
                return xScale(+d.prostitution); 
            })
            .attr("y", function(d) {
                return -10 + yScale(+d.vehicle_theft);
            })
            .attr("fill", function(d,i) { return color(i);
            })
            .on("mouseover", tip.show)
            .on("mouseout", tip.hide);

        
        var xAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient("bottom")
                  .ticks(5);
        
        var yAxis = d3.svg.axis()
                  .scale(yScale)
                  .orient("left")
                  .ticks(5);
        
        
        svgScatter.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + (height-padding) + ")")
            .call(xAxis)
            .append("text")
            .attr("class", "labelaxis")
            .attr("y", 45)
            .attr("x", 360)
            .text("Prostitution");
            
        svgScatter.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(" + padding + ",0)")
            .call(yAxis)
            .append("text")
              .attr("class", "labelaxis")
              .attr("transform", "rotate(-90)")
              .attr("y", 200)
              .attr("x", 20)
              .attr("dy", "-15.5em")
              .attr("dx", "-12em")
              .style("text-anchor", "end")
            .text("Vehicle theft");
    }
        
    function color(n) {
        var colores_g = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477", "#66aa00", "#b82e2e", "#316395", "#994499", "#22aa99", "#aaaa11", "#6633cc", "#e67300", "#8b0707", "#651067", "#329262", "#5574a6", "#3b3eac"];
        return colores_g[n % colores_g.length];
    }
     /**************************************************************GEODATA**********************************************************************************************   */

    // Declare the global variables
    var svgGEO = undefined;
    var w = 960;
    var h = 500;
    var kData = [];
    var kMeansData = {};

    //Define map projection
    var projection = d3.geo.mercator()
        .scale(155000)
        .center([-122.45, 37.76]) // Center the Map in San Francisco
        .translate([w/2, h/2]);
        
    //Load in GeoJSON data
    d3.json("https://gist.githubusercontent.com/SkuliSkula/ef293552320cea71928b7c92634ed5f2/raw/f7c8bc58b592b4af0e01703787b7cdf1f2db3e78/geodata.geojson", function(error, data) {
        if(error) {
            console.log(error);
        } else{
            initGeoVisualization(data);
            loadKData();
            
        }
    });
        
    function loadKData() {
        d3.csv("https://gist.githubusercontent.com/SkuliSkula/71a4946b7202437bd37eb4daeaca7668/raw/efb16d458edaae3b5b2ef469f08cfbb87bd0d5a5/k_means_lat_lon.csv", function(error, data) {
            if(error) {
                console.log(error);
            } else {                
                kData = data;
                initKData(kData);
                loadKMeansData();
            }
        });
    }
        
    function loadKMeansData() {
        d3.json("https://gist.githubusercontent.com/SkuliSkula/70d040b30a179db41af89d83e89e98cc/raw/3d76e7f351056c3978a3361cbc93de42965e1bf1/k_means_cluster_centers.json", function(error, data){
           if(error)
               console.log("LoadKMeans error: ", error);
            else
                kMeansData = data;
                initGeoKMeansCircles();
        });
    }
        
    function initKData(data) {
        
        svgGEO.selectAll(".in")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "kCircle")
            .attr("cx", function(d) {
                return projection([d.lon, d.lat])[0];
            })
            .attr("cy", function(d) {
                return projection([d.lon, d.lat])[1];
            })
            .attr("r", 1.5)
            .attr("fill", function(d, i){
                if(+d.k2 == 0)
                    return colorKCircle(0);
            else if(d.k2 == 1)
                    return colorKCircle(1);
        });
    }
        
        function removeCircles(){
            svgGEO.selectAll(".geokmeans").remove(); 
        }
        
    function initGeoKMeansCircles(k) {
        var dataK = [];
        if(!k) {
            dataK = jsonToArray("k2");
        }else {
            removeCircles();
            dataK = jsonToArray(k);
        }
    
        svgGEO.selectAll(".out")
            .data(dataK[0])
            .enter()
            .append("circle")
            .attr("class", "geokmeans")
            .attr("cx", function(d) {
                return projection([d.lon, d.lat])[0];
            })
            .attr("cy", function(d) {
                return projection([d.lon, d.lat])[1];
            })
            .attr("r", 12)
            .attr("fill", function(d, i){
                return colorKCircle(i);
        });
        
    }
        
    function initGeoVisualization(data) {

        //Define default path generator
        var path = d3.geo.path().projection(projection);

        //Create SVG element
        svgGEO = d3.select("#visualization2")
                .append("svg")
                .attr("width", w)
                .attr("height", h);
        
        //Bind data and create one path per GeoJSON feature
        svgGEO.selectAll("path")
           .data(data.features)
           .enter()
           .append("path")
           .attr("class", "geodistrict")
           .attr("d", path)
           .style("stroke-width", 0.7)
           .style("stroke", "black")
           .style("fill", "steelblue");
        
        // Add district labels
        svgGEO.selectAll("text")
           .data(data.features)
           .enter()
           .append("svg:text")
           .text(function(d){
                return d.properties.DISTRICT;
           })
           .attr("x", function(d){
                return path.centroid(d)[0];
           })
           .attr("y", function(d){
                return path.centroid(d)[1];
           })
           .attr("text-anchor","middle")
           .attr("font-size","8pt")
           .style("fill", "#ccc");
    }
        
    function showKData(k) {
        
        initGeoKMeansCircles(k);
        
        svgGEO.selectAll("circle")
            .data(kData)
            .attr("cx", function(d) {
                return projection([d.lon, d.lat])[0];
            })
            .attr("cy", function(d) {
                return projection([d.lon, d.lat])[1];
            })
            .attr("r", 1.5)
            .attr("fill", function(d, i){
                if(k == "k2") {
                    if(+d.k2 === 0)
                        return colorKCircle(0);
                    else if(+d.k2 === 1)
                        return colorKCircle(1);
                }
            else if(k == "k3") {
                    if(+d.k3 === 0)
                        return colorKCircle(0);
                    else if(+d.k3 === 1)
                        return colorKCircle(1);
                    else if(+d.k3 === 2)
                        return colorKCircle(2);
                
            }
            else if(k == "k4") {
                    if(+d.k4 === 0)
                        return colorKCircle(0);
                    else if(+d.k4 === 1)
                        return colorKCircle(1);
                    else if(+d.k4 === 2)
                        return colorKCircle(2);
                    else if(+d.k4 === 3)
                        return colorKCircle(3);
            }else if(k == "k5") {
                    if(+d.k5 === 0)
                        return colorKCircle(0);
                    else if(+d.k5 === 1)
                        return colorKCircle(1);
                    else if(+d.k5 === 2)
                        return colorKCircle(2);
                    else if(+d.k5 === 3)
                        return colorKCircle(3);
                    else if(+d.k5 === 4)
                        return colorKCircle(4);
            }else {
                    if(+d.k6 === 0)
                        return colorKCircle(0);
                    else if(+d.k6 === 1)
                        return colorKCircle(1);
                    else if(+d.k6 === 2)
                        return colorKCircle(2);
                    else if(+d.k6 === 3)
                        return colorKCircle(3);
                    else if(+d.k6 === 4)
                        return colorKCircle(4);
                    else if(+d.k6 === 5)
                        return colorKCircle(5);
            }

            });
    }
			
	function colorKCircle(color) {
        var colores_g = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#b82e2e"];
        return colores_g[color];
    }	
        
    function jsonToArray(k) {
        var temp = [];
        for(var i in kMeansData) {
            if(i == k)
                temp.push(kMeansData[i]);
        }
        return temp;
    }
    
    </script>
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <h1>Assignment 2A:</h1>
                <h3>Scatterplot of Prostitution and Vehicle Theft</h3>
                <p>Scatterplot showing crime data from ten districts of San Francisco. Prostitution is on the x-axis and Vehicle Theft is on the y-axis. Click on the buttons to see difference between data from 2003 and 2015</p>
               <div class="btn-group" data-toggle="buttons">
                    <label class="btn btn-info active" onclick="switchData(true);" style="outline: 0">
                        <input type="radio" name="options" id="data2003" autocomplete="off" checked> Data 2003
                    </label>
                    <label class="btn btn-info" onclick="switchData(false);" style="outline: 0">
                        <input type="radio" name="options" id="data2015" autocomplete="off"> Data 2015
                    </label>
                </div>
                <div id="visualization1" class="scatter">
                </div>
                <h4>Explain in your own words why you think I want the axes to be the same for both years? (Even though you know how to make axes adapt to the data values.)</h4>
                <p>Answer: </p>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <h1>Assignment 2B:</h1>
                    <h3>Assignment title</h3>
                    <p>More detailed assignment explanation</p>
                    <div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-info active" onclick="showKData('k2')" style="outline: 0">
                            <input type="radio" name="options" autocomplete="off">K = 2
                        </label>
                        <label class="btn btn-info" onclick="showKData('k3')" style="outline: 0">
                            <input type="radio" name="options" autocomplete="off">K = 3
                        </label>
                        <label class="btn btn-info" onclick="showKData('k4')" style="outline: 0">
                            <input type="radio" name="options" autocomplete="off">K = 4
                        </label>
                        <label class="btn btn-info" onclick="showKData('k5')" style="outline: 0">
                            <input type="radio" name="options" autocomplete="off">K = 5
                        </label>
                        <label class="btn btn-info" onclick="showKData('k6')" style="outline: 0">
                            <input type="radio" name="options" autocomplete="off">K = 6
                        </label>
                    </div>
                    <div id="visualization2" class="geoplot"></div>
                </div>
            </div>
        </div>
    </div>
  </body>

</html>